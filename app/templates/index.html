<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WattsUp – Energy Anomaly Detection</title>

  <!-- Bootstrap & Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    body.light-theme { background: #fff; color: #000; }
    body.dark-theme { background: #121212; color: #fff; }
    canvas { margin-top: 30px; }
    #spinner { display: none; }
    .date-range { margin-top: 1rem; }
    .anomaly-table th, .anomaly-table td { text-align: center; }
  </style>
</head>

<body class="light-theme text-center p-4">
  <h1 class="mb-4">⚡ WattsUp – Upload CSV</h1>

  <!-- Toggles -->
  <div class="form-check form-switch d-inline me-3">
    <input class="form-check-input" type="checkbox" id="themeToggle">
    <label class="form-check-label" for="themeToggle">Dark Mode</label>
  </div>
  <div class="form-check form-switch d-inline me-3">
    <input class="form-check-input" type="checkbox" id="toggleAnomalies" checked>
    <label class="form-check-label" for="toggleAnomalies">Show Anomalies</label>
  </div>
  <div class="form-check form-switch d-inline me-3">
    <input class="form-check-input" type="checkbox" id="toggleMA" checked>
    <label class="form-check-label" for="toggleMA">Show Moving Average</label>
  </div>

  <!-- Model Selector -->
  <div class="mt-3">
    <label for="modelSelect">🔍 Choose Detection Model:</label>
    <select id="modelSelect" class="form-select w-25 d-inline">
      <option value="isolation_forest">Isolation Forest</option>
      <option value="lof">Local Outlier Factor</option>
      <option value="ocsvm">One-Class SVM</option>
      <option value="autoencoder">AutoEncoder</option>
    </select>
  </div>

  <!-- Upload -->
  <form id="uploadForm" class="mt-3">
    <input type="file" name="file" id="fileInput" required class="form-control w-25 d-inline"/>
    <button type="submit" class="btn btn-primary ms-2">Upload & Detect</button>
  </form>

  <!-- 📡 Start Live Stream Button -->
  <div class="mt-3">
    <button id="startLiveStreamBtn" class="btn btn-info">📡 Start Live Stream</button>
  </div>

  <!-- Spinner -->
  <div id="spinner" class="mt-3">
    <div class="spinner-border text-primary" role="status"></div>
    <p>Processing CSV...</p>
  </div>

  <!-- Download Buttons -->
  <a id="downloadLink" class="btn btn-success btn-sm ms-2" style="display:none;" download="wattsup_anomalies.csv">Download CSV</a>
  <button id="downloadImage" class="btn btn-outline-primary btn-sm ms-2" style="display:none;">Download PNG</button>
  <button id="downloadPDF" class="btn btn-outline-dark btn-sm ms-2" style="display:none;">Export PDF</button>

  <!-- Date Range Filter -->
  <div class="date-range">
    <label>Filter Date Range:</label>
    <input type="date" id="startDate" class="mx-2"/>
    <input type="date" id="endDate"/>
    <button id="applyFilter" class="btn btn-sm btn-secondary ms-2">Apply</button>
  </div>

  <!-- Chart Canvas -->
  <div style="position: relative; height: 400px; width: 100%; max-width: 1000px; margin: auto;">
    <canvas id="chartCanvas"></canvas>
  </div>

  <!-- Zoom/Pan Controls -->
  <div class="mt-3">
    <button class="btn btn-outline-secondary btn-sm" onclick="panChart('left')">←</button>
    <button class="btn btn-outline-secondary btn-sm" onclick="panChart('right')">→</button>
    <button class="btn btn-outline-secondary btn-sm" onclick="panChart('up')">↑</button>
    <button class="btn btn-outline-secondary btn-sm" onclick="panChart('down')">↓</button>
    <button class="btn btn-outline-secondary btn-sm ms-2" onclick="zoomChart('in')">➕ Zoom In</button>
    <button class="btn btn-outline-secondary btn-sm" onclick="zoomChart('out')">➖ Zoom Out</button>
    <button class="btn btn-warning btn-sm ms-2" onclick="resetZoom()">🔄 Reset</button>
  </div>

  <!-- Anomaly Table -->
  <div id="anomalyTableContainer" class="container mt-4" style="display:none;">
    <h5 class="text-center">📉 Detected Anomalies</h5>
    <table class="table table-bordered table-sm anomaly-table">
      <thead><tr><th>Date</th><th>Energy Usage (kWh)</th></tr></thead>
      <tbody id="anomalyTableBody"></tbody>
    </table>
  </div>

  <!-- ✅ Live Anomaly Table Added -->
  <div id="liveAnomalyTableContainer" class="container mt-4" style="display: none;">
    <h5 class="text-center">📡 Real-Time Detected Anomalies</h5>
    <table class="table table-bordered table-sm anomaly-table">
      <thead><tr><th>Timestamp</th><th>Energy Usage (kWh)</th><th>Cause</th></tr></thead>
      <tbody id="liveAnomalyTableBody"></tbody>
    </table>
  </div>

  <script>
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const modelSelect = document.getElementById('modelSelect');
    const ctx = document.getElementById('chartCanvas').getContext('2d');
    const spinner = document.getElementById('spinner');
    const anomalyToggle = document.getElementById('toggleAnomalies');
    const toggleMA = document.getElementById('toggleMA');
    const downloadLink = document.getElementById('downloadLink');
    const downloadImage = document.getElementById('downloadImage');
    const downloadPDF = document.getElementById('downloadPDF');
    const tableContainer = document.getElementById('anomalyTableContainer');
    const tableBody = document.getElementById('anomalyTableBody');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const applyFilterBtn = document.getElementById('applyFilter');
    const startLiveStreamBtn = document.getElementById('startLiveStreamBtn');

    let chartInstance = null;
    let fullData = [];

    themeToggle.onchange = () => {
      document.body.classList.toggle('dark-theme');
      document.body.classList.toggle('light-theme');
    };

    function movingAverage(data, windowSize = 20) {
      const result = [];
      for (let i = 0; i < data.length; i++) {
        const start = Math.max(0, i - windowSize + 1);
        const slice = data.slice(start, i + 1);
        const avg = slice.reduce((sum, val) => sum + val, 0) / slice.length;
        result.push(+avg.toFixed(2));
      }
      return result;
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      spinner.style.display = 'block';
      tableContainer.style.display = 'none';

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('model', modelSelect.value);

      const response = await fetch('/upload', { method: 'POST', body:formData });
      const data = await response.json();
      fullData = data;
      spinner.style.display = 'none';

      downloadLink.style.display = downloadImage.style.display = downloadPDF.style.display = 'inline';
      renderChart(data);
      renderAnomalyTable(data);

      const csvRows = ["timestamp,energy_usage,anomaly"];
      data.forEach(d => {
        const line = `${d.timestamp},${d.energy_usage},${d.anomaly}`;
        if (!csvRows.includes(line)) csvRows.push(line);
      });
      const blob = new Blob([csvRows.join("\n")], { type: 'text/csv' });
      downloadLink.href = URL.createObjectURL(blob);
    };

    const renderChart = (data) => {
      const labels = data.map(d => d.timestamp);
      const usage = data.map(d => d.energy_usage);
      const anomalies = data.map(d => d.anomaly === -1 ? d.energy_usage : null);
      const maData = movingAverage(usage);

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Energy Usage', data: usage, borderColor: 'blue', borderWidth: 1.5, pointRadius: 0 },
            { label: 'Anomalies', data: anomalies, pointBackgroundColor: 'red', pointRadius: 6, type: 'scatter', showLine: false },
            { label: 'Moving Avg (20)', data: maData, borderColor: 'green', borderDash: [5, 5], borderWidth: 2, pointRadius: 0 }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            zoom: {
              pan: { enabled: true, mode: 'xy' },
              zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' }
            }
          },
          scales: {
            x: { title: { display: true, text: 'Date' }, ticks: { autoSkip: true, maxTicksLimit: 15 } },
            y: { title: { display: true, text: 'Usage (kWh)' } }
          }
        }
      });

      anomalyToggle.onchange = () => {
        chartInstance.data.datasets[1].hidden = !anomalyToggle.checked;
        chartInstance.update();
      };

      toggleMA.onchange = () => {
        chartInstance.data.datasets[2].hidden = !toggleMA.checked;
        chartInstance.update();
      };
    };

    const renderAnomalyTable = (data) => {
      const anomalies = data.filter(d => d.anomaly === -1);
      tableBody.innerHTML = "";
      if (anomalies.length === 0) {
        tableContainer.style.display = 'none';
        return;
      }

      anomalies.forEach(row => {
        tableBody.innerHTML += `<tr><td>${row.timestamp}</td><td>${row.energy_usage.toFixed(2)}</td></tr>`;
      });
      tableContainer.style.display = 'block';
    };

    applyFilterBtn.onclick = () => {
      const start = startDateInput.value;
      const end = endDateInput.value;
      if (!start || !end) return alert("Please select both dates.");
      const filtered = fullData.filter(d => d.timestamp >= start && d.timestamp <= end);
      if (filtered.length === 0) return alert("No data in selected range.");
      renderChart(filtered);
      renderAnomalyTable(filtered);
    };

    downloadImage.onclick = () => {
      const link = document.createElement('a');
      link.href = chartInstance.toBase64Image();
      link.download = "wattsup_chart.png";
      link.click();
    };

    downloadPDF.onclick = () => {
      html2pdf().from(document.body).save('wattsup_report.pdf');
    };

    function panChart(direction) {
      const amount = 100;
      if (!chartInstance) return;
      switch (direction) {
        case 'left': chartInstance.pan({ x: -amount }); break;
        case 'right': chartInstance.pan({ x: amount }); break;
        case 'up': chartInstance.pan({ y: -amount }); break;
        case 'down': chartInstance.pan({ y: amount }); break;
      }
    }

    function zoomChart(direction) {
      const factor = direction === 'in' ? 1.2 : 0.8;
      chartInstance?.zoom(factor);
    }

    function resetZoom() {
      chartInstance?.resetZoom();
    }

    // ✅ WebSocket Live Stream with Anomaly Support
    const socket = io("http://localhost:5000");

    const liveLabels = [];
    const liveUsageData = [];
    const liveAnomalyData = [];
    const liveAnomalyMetadata = [];

    startLiveStreamBtn.onclick = () => {
      socket.emit('start_stream');
    };

    socket.on('live_data', (row) => {
      const timestamp = row.timestamp;
      const usage = parseFloat(row.energy_usage);
      const isAnomaly = row.anomaly === 1;
      const cause = row.cause;

      liveLabels.push(timestamp);
      liveUsageData.push(usage);
      liveAnomalyData.push(isAnomaly ? usage : null);
      liveAnomalyMetadata.push(isAnomaly ? cause : null);

      if (!chartInstance) {
        chartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: liveLabels,
            datasets: [
              {
                label: 'Live Energy Usage',
                data: liveUsageData,
                borderColor: 'orange',
                borderWidth: 2,
                pointRadius: 2
              },
              {
                label: 'Anomalies',
                data: liveAnomalyData,
                pointBackgroundColor: 'red',
                pointRadius: 6,
                type: 'scatter',
                showLine: false
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const idx = context.dataIndex;
                    if (context.dataset.label === 'Anomalies') {
                      return `⚠ Anomaly: ${liveAnomalyData[idx]} kWh (${liveAnomalyMetadata[idx] || 'Unknown'})`;
                    }
                    return `Usage: ${liveUsageData[idx]} kWh`;
                  }
                }
              }
            },
            scales: {
              x: { title: { display: true, text: 'Timestamp' } },
              y: { title: { display: true, text: 'Usage (kWh)' } }
            }
          }
        });
      } else {
        chartInstance.data.labels.push(timestamp);
        chartInstance.data.datasets[0].data.push(usage);
        chartInstance.data.datasets[1].data.push(isAnomaly ? usage : null);
        liveAnomalyMetadata.push(isAnomaly ? cause : null);

        const maxPoints = 100;
        if (chartInstance.data.labels.length > maxPoints) {
          chartInstance.data.labels.shift();
          chartInstance.data.datasets[0].data.shift();
          chartInstance.data.datasets[1].data.shift();
          liveAnomalyMetadata.shift();
        }

        chartInstance.update();
      }

      // ✅ Append anomaly to live table
      if (isAnomaly) {
        const tableContainer = document.getElementById('liveAnomalyTableContainer');
        const tableBody = document.getElementById('liveAnomalyTableBody');
        tableContainer.style.display = 'block';
        const rowHTML = `<tr><td>${timestamp}</td><td>${usage.toFixed(2)}</td><td>${cause || 'Unknown'}</td></tr>`;
        tableBody.innerHTML += rowHTML;
      }
    });
  </script>
</body>
</html>